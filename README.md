# Zotero S3 同步插件

[![版本](https://img.shields.io/github/v/release/John10240/zotero-plugin2)](https://github.com/John10240/zotero-plugin2/releases)
[![许可证](https://img.shields.io/github/license/John10240/zotero-plugin2)](LICENSE)
[![下载量](https://img.shields.io/github/downloads/John10240/zotero-plugin2/total)](https://github.com/John10240/zotero-plugin2/releases)

一个功能完整的 Zotero 附件 S3 双向同步插件，支持上传、下载、冲突处理和智能增量同步。

> **⚠️ 使用提醒**
>
> 当前版本为 **v0.1.21**，核心功能已稳定。使用前请：
>
> - 📦 备份你的 Zotero 数据库和附件
> - 🧪 建议先在测试环境中试用
> - 🐛 遇到问题请提交 [Issue](https://github.com/John10240/zotero-plugin2/issues)
>
> **已实现功能**：
>
> - ✅ 双向同步（上传和下载）
> - ✅ 智能三路合并算法
> - ✅ 冲突检测和解决
> - ✅ 增量同步（仅同步变更文件）
> - ✅ 本地文件删除检测
>
> **计划中功能**：
>
> - 🚧 自动定时同步
> - 🚧 从 S3 下载文件的 UI 集成

## 功能特性

### 核心同步功能
- ✅ **双向同步**：上传本地文件到 S3，下载 S3 文件到本地
- ✅ **智能三路合并**：基于本地、远程和上次同步状态的智能决策
- ✅ **增量同步**：仅同步变更的文件，节省时间和带宽
- ✅ **冲突处理**：自动检测冲突并提供多种解决策略
  - 本地优先
  - 远程优先
  - 较新文件优先
  - 手动选择
- ✅ **文件删除同步**：检测并同步本地和远程的文件删除

### S3 存储支持
- ✅ 支持任何 S3 兼容的对象存储
  - AWS S3
  - MinIO
  - 阿里云 OSS
  - 腾讯云 COS
  - 其他兼容 S3 API 的存储
- ✅ 可配置的文件路径前缀
- ✅ MD5 哈希校验确保数据完整性
- ✅ 支持自定义元数据存储

### 用户体验
- ✅ 实时同步进度显示
- ✅ 详细的调试日志输出
- ✅ 连接测试功能
- ✅ 中英文双语界面

## 安装

### 正式版安装

1. 从 [Releases 页面](https://github.com/John10240/zotero-plugin2/releases) 下载最新的 `.xpi` 文件
2. 在 Zotero 中，打开 **工具 → 插件**
3. 点击右上角的齿轮图标，选择 **"从文件安装插件"**
4. 选择下载的 `.xpi` 文件
5. 重启 Zotero

### 测试版安装

如果你想测试开发中的功能，可以从 [Actions](https://github.com/John10240/zotero-plugin2/actions) 页面下载最新构建的测试版本。

**注意**：测试版可能不稳定，请谨慎使用！

### 系统要求

- Zotero 7.0+ (Beta 版本)
- Windows / macOS / Linux

## 配置

1. 打开 Zotero -> 编辑 -> 设置 -> S3 同步设置
2. 配置以下信息：
   - **S3 端点**: S3 服务的端点 URL（例如：`https://s3.amazonaws.com`）
   - **区域**: S3 区域（例如：`us-east-1`）
   - **存储桶名称**: 你的 S3 存储桶名称
   - **访问密钥 ID**: S3 访问密钥 ID
   - **秘密访问密钥**: S3 秘密访问密钥
   - **文件前缀**: 存储在 S3 中的文件路径前缀（默认：`zotero-attachments`）

3. 点击"测试连接"按钮验证配置是否正确

## 使用方法

### 手动同步

1. 打开 Zotero
2. 点击菜单栏 工具 -> 同步到 S3
3. 插件会自动检测所有需要同步的附件并开始上传
4. 同步进度会显示在弹出窗口中

### 自动同步

在设置中勾选"启用自动同步"即可启用自动同步功能（计划中）。

## S3 兼容存储配置示例

### AWS S3

```
端点: https://s3.amazonaws.com
区域: us-east-1 (或其他区域)
```

### MinIO

```
端点: http://localhost:9000 (或你的 MinIO 服务器地址)
区域: us-east-1 (MinIO 默认区域)
```

### 阿里云 OSS

```
端点: https://oss-cn-hangzhou.aliyuncs.com (根据你的区域修改)
区域: oss-cn-hangzhou (根据你的区域修改)
```

### 腾讯云 COS

```
端点: https://cos.ap-guangzhou.myqcloud.com (根据你的区域修改)
区域: ap-guangzhou (根据你的区域修改)
```

## 工作原理

### 同步算法

插件采用智能的**三路合并算法**来决定文件的同步操作：

1. **文件扫描**：扫描 Zotero 库中的所有附件文件和 S3 存储
2. **哈希计算**：计算本地文件的 MD5 哈希值
3. **三路比较**：比较三个状态
   - 📁 本地文件当前状态
   - ☁️ 远程 S3 文件当前状态
   - 📝 上次成功同步时的状态
4. **决策逻辑**：
   - 仅本地改变 → **上传**
   - 仅远程改变 → **下载**
   - 双方都改变 → **冲突**（根据策略处理）
   - 双方未变 → **跳过**
   - 仅本地存在 → **上传新文件**
   - 仅远程存在 → **下载新文件**
   - 本地删除 + 远程存在 → **删除远程**
   - 远程删除 + 本地存在 → **删除本地**
5. **元数据记录**：记录同步时间、文件哈希值和修改时间

### 冲突处理

当检测到本地和远程文件都被修改时：
- **手动模式**：弹出对话框让用户选择
- **自动模式**：根据配置的策略自动解决
  - `local-wins`：使用本地文件覆盖远程
  - `remote-wins`：使用远程文件覆盖本地
  - `newer-wins`：使用修改时间较新的文件

## 版本历史

### v0.1.21 - 当前版本 (2026-01-07)

**重要 Bug 修复**：

- 🐛 **修复了文件重复下载问题**：即使本地和远程文件相同，也会重复下载的严重 bug
  - 根本原因：`determineOperation` 方法缺少 `async` 关键字，导致 `await` 被忽略
  - 影响：所有文件在每次同步时都会被错误地标记为需要下载
  - 修复：添加 `async` 关键字并更新返回类型为 `Promise<SyncOperation>`
- ✨ 增强了 no-change 文件的元数据记录
- 📝 添加了详细的调试日志便于问题诊断

**建议升级**：如果你在使用 v0.1.17-v0.1.20，强烈建议升级到此版本！

### v0.1.17-v0.1.20 (已过时)

⚠️ 这些版本存在严重的重复下载 bug，请升级到 v0.1.21

### v0.1.0-v0.1.16 (早期版本)

**新功能**：

- ✨ 实现 S3 客户端和同步管理器
- ✨ 支持双向同步（上传和下载）
- ✨ 智能三路合并算法
- ✨ 冲突检测和解决
- ✨ 连接测试功能
- ✨ 增量同步支持
- ✨ 多语言支持（中文/英文）

查看完整的 [版本发布记录](https://github.com/John10240/zotero-plugin2/releases)

## 贡献与反馈

### 报告问题

如果你遇到 Bug 或有功能建议，请：

1. 查看 [已知问题](https://github.com/John10240/zotero-plugin2/issues)
2. 如果问题未被报告，[创建新 Issue](https://github.com/John10240/zotero-plugin2/issues/new)
3. 提供详细信息：Zotero 版本、操作系统、错误日志等

### 参与开发

欢迎提交 Pull Request！请查看下方的开发部分了解如何构建项目。

## 开发

### 环境要求

- Node.js 18+
- npm 或 pnpm
- Zotero 7 Beta

### 构建

```bash
# 安装依赖
npm install

# 开发模式（热重载）
npm start

# 生产构建
npm run build
```

构建产物位于 `.scaffold/build/` 目录。

### 项目结构

```
src/
├── modules/
│   ├── s3Client.ts        # S3 客户端封装
│   ├── syncManager.ts     # 同步管理器
│   ├── examples.ts        # 示例代码
│   └── preferenceScript.ts # 偏好设置脚本
├── utils/                 # 工具函数
├── hooks.ts               # 生命周期钩子
├── addon.ts               # 插件主类
└── index.ts               # 入口文件
```

## 常见问题

### Q: 支持下载文件吗？

A: **完全支持**！插件实现了完整的双向同步功能。当远程文件比本地文件新时，会自动下载。

### Q: 如何处理同步冲突？

A: 插件提供了多种冲突解决策略：
- 在设置中配置自动策略（本地优先/远程优先/较新文件优先）
- 或在同步时手动选择如何处理每个冲突

### Q: 文件会被压缩吗？

A: 不会。文件以原始格式上传到 S3，保证完整性。

### Q: 如何删除 S3 上的文件？

A: 插件支持自动删除同步：
- 如果你在本地删除了文件，下次同步时会自动删除 S3 上的对应文件
- 如果 S3 上的文件被删除，下次同步时会自动删除本地文件
- 你也可以手动在 S3 控制台中删除文件

### Q: 为什么文件总是被重复下载？

A: 如果你使用的是 v0.1.17-v0.1.20 版本，这是一个已知的严重 bug。请立即升级到 v0.1.21 或更新版本。

### Q: 同步失败怎么办？

A: 请检查：

1. S3 配置是否正确（使用"测试连接"功能验证）
2. 网络连接是否正常
3. S3 存储桶权限是否足够（需要 GetObject、PutObject、DeleteObject、ListBucket 权限）
4. 查看 Zotero 的调试输出（帮助 -> 调试输出日志）获取详细错误信息

### Q: 增量同步是如何工作的？

A: 插件会记录每个文件的同步状态：
- 首次同步会同步所有文件
- 后续同步只处理有变化的文件（通过 MD5 哈希值比较）
- 大大节省了时间和带宽

## 许可证

AGPL-3.0-or-later

## 致谢

本插件基于 [Zotero Plugin Template](https://github.com/windingwind/zotero-plugin-template) 构建。
